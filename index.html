<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Eventos</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
</head>
<body>
  <h1>Gestión de Eventos</h1>

  <div id="loginSection">
    <h2>Iniciar Sesión (Organizador)</h2>
    <input type="text" id="username" placeholder="Usuario">
    <input type="password" id="password" placeholder="Contraseña">
    <button id="loginBtn">Entrar</button>
    <p id="status">🔴 Sin conexión</p>
  </div>

  <div id="organizerSection" style="display:none;">
    <h2>Crear Evento</h2>
    <form id="createEventForm">
      <input type="text" id="eventName" placeholder="Nombre del evento" required>
      <input type="date" id="eventDate" required>
      <button type="submit">Crear Evento</button>
    </form>

    <h2>Eventos</h2>
    <ul id="eventsList"></ul>
  </div>

  <div id="assistantSection">
    <h2>Unirse a Evento</h2>
    <input type="text" id="eventCode" placeholder="Código del evento">
    <input type="text" id="assistantName" placeholder="Tu nombre">
    <button id="joinBtn">Unirme</button>
  </div>

  <script>
    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBCKYH6fFZIQI04FVpTm9CSU8jrf3dW0fI",
      authDomain: "voluntariado-cmusa.firebaseapp.com",
      projectId: "voluntariado-cmusa",
      storageBucket: "voluntariado-cmusa.appspot.com",
      messagingSenderId: "163763370924",
      appId: "1:163763370924:web:cdcb268624e3b58e88dcfd"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Verificar conexión
    db.collection("__test").get().then(() => {
      document.getElementById("status").textContent = "🟢 Conectado";
    }).catch(() => {
      document.getElementById("status").textContent = "🔴 Sin conexión";
    });

    // Login rápido
    document.getElementById("loginBtn").addEventListener("click", () => {
      const user = document.getElementById("username").value;
      const pass = document.getElementById("password").value;
      if(user === "admin" && pass === "123456") {
        document.getElementById("organizerSection").style.display = "block";
        document.getElementById("loginSection").style.display = "none";
        // Ocultar estado al iniciar sesión
        document.getElementById("status").style.display = "none";
      } else {
        alert("Credenciales inválidas");
      }
    });

    // Crear evento
    document.getElementById("createEventForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("eventName").value;
      const date = document.getElementById("eventDate").value;
      try {
        const docRef = await db.collection("events").add({
          name,
          date,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Evento creado con código: " + docRef.id);
        document.getElementById("createEventForm").reset();
        loadEvents();
      } catch (err) {
        console.error("Error creando evento:", err);
      }
    });

    // Cargar eventos
    async function loadEvents() {
      const list = document.getElementById("eventsList");
      list.innerHTML = "";
      const snapshot = await db.collection("events").orderBy("createdAt", "desc").get();
      snapshot.forEach(doc => {
        const li = document.createElement("li");
        const data = doc.data();
        li.innerHTML = `<b>${data.name}</b> (${data.date})<br>
          Código: ${doc.id}<br>
          <div id="qrcode-${doc.id}"></div>
          <button onclick="exportCSV('${doc.id}')">Exportar CSV</button>
          <button onclick="deleteEvent('${doc.id}')">Eliminar</button>`;
        list.appendChild(li);
        new QRCode(document.getElementById("qrcode-" + doc.id), {
          text: doc.id,
          width: 100,
          height: 100
        });
      });
    }

    // Unirse a evento
    document.getElementById("joinBtn").addEventListener("click", async () => {
      const code = document.getElementById("eventCode").value;
      const name = document.getElementById("assistantName").value;
      if(!code || !name) return alert("Completa todos los campos");
      try {
        await db.collection("events").doc(code).collection("attendees").add({
          name,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert("Registrado en el evento");
      } catch (err) {
        alert("Código inválido");
      }
    });

    // Exportar CSV
    async function exportCSV(eventId) {
      const snapshot = await db.collection("events").doc(eventId).collection("attendees").get();
      let csv = "Nombre,Fecha\n";
      snapshot.forEach(doc => {
        const d = doc.data();
        csv += `${d.name},${d.createdAt ? d.createdAt.toDate().toLocaleString() : ""}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `asistentes-${eventId}.csv`;
      a.click();
    }

    // Eliminar evento
    async function deleteEvent(eventId) {
      if(!confirm("¿Eliminar evento y asistentes?")) return;
      const attendees = await db.collection("events").doc(eventId).collection("attendees").get();
      const batch = db.batch();
      attendees.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
      await db.collection("events").doc(eventId).delete();
      loadEvents();
    }

    loadEvents();
  </script>
</body>
</html>
